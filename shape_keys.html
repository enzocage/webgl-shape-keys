<html>

<head>

<title>Shape Keys</title>

<script type="text/javascript" src="./other/gl-matrix-min.js"></script>
<script type="text/javascript" src="./other/webgl-utils.js"></script>
<script type="text/javascript" src="./webgl-helper.js"></script>
<script type="text/javascript" src="./camera.js"></script>

<script type="text/javascript">

function startPage() {
	var canvas = document.getElementById("main-canvas");
	var gl = initGL(canvas);
	
	initShaders(gl);
	initBuffers(gl);
	
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.enable(gl.DEPTH_TEST);
	gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
	
	gl.pMatrix = mat4.create();
	mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, gl.pMatrix);
	
	gl.camera = new Camera();
	
	startAnimation(gl, tick);
}

function initShaders(gl) {
	attributeNames = ["aTextureCoord","aPosition0", "aNormal0", "aPosition1", "aNormal1", "aPosition2", "aNormal2" ];
	uniformNames = ["uWeight1", "uWeight2","uMVMatrix", "uPMatrix", "uNMatrix", "uDiffuseColor", "uUseTexture", "uSampler"];
	
	gl.shaderProg = createShaderProgram(gl, "shape_keys.vert", "shape_keys.frag", attributeNames, uniformNames);
	
	gl.useProgram(gl.shaderProg);

	for (a in gl.shaderProg.attributes) {
		var attribLoc = gl.shaderProg.attributes[a]
		gl.enableVertexAttribArray(attribLoc);
	}
}

function initBuffers(gl) {
	gl.models = [];
	createModel(gl, "models/Face.js", gl.models);
	createModel(gl, "models/EyeLid.000.js", gl.models);
	createModel(gl, "models/EyeLid.001.js", gl.models);
	createModel(gl, "models/EyeLid.002.js", gl.models);
	createModel(gl, "models/EyeLid.003.js", gl.models);
	createModel(gl, "models/Eye.001_0.js", gl.models);
	createModel(gl, "models/Eye.001_1.js", gl.models);
	createModel(gl, "models/Eye.001_2.js", gl.models);
	createModel(gl, "models/Eye.002_0.js", gl.models);
	createModel(gl, "models/Eye.002_1.js", gl.models);
	createModel(gl, "models/Eye.002_2.js", gl.models);
	createModel(gl, "models/Teeth_0.js", gl.models);
	createModel(gl, "models/Teeth_1.js", gl.models);
}

function tick(gl, timing) {
	draw(gl, timing);
	
	var fpsDiv = document.getElementById("fps");
	
	if(fpsDiv.innerHTML != timing.fps)
		fpsDiv.innerHTML = timing.fps;
}

function draw(gl, timing) {
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	
	var mvMatrix = mat4.create();

	mat4.identity(mvMatrix);
	mat4.rotateX(mvMatrix, degToRadian(-90));
	mat4.translate(mvMatrix, [0.0, 0.0, 1.25]);
	
	gl.camera.update(timing);
	var cMatrix = gl.camera.getViewMatrix();
	mat4.multiply(cMatrix, mvMatrix, mvMatrix);
	
	var nMatrix = mat3.create();
	mat4.toInverseMat3(mvMatrix, nMatrix);
	mat3.transpose(nMatrix);
	
	//I'm using a while loop here instead of a for loop, because 
	//when I use a for loop the browser will freeze up. I'm not sure
	//what is causing this, but everything works fine with a while loop.
	var i = 0;
	while(i < gl.models.length) {
		drawModel(gl, timing, gl.models[i], mvMatrix, nMatrix);
		i++;
	}
}

function drawModel(gl, timing, model, mvMatrix, nMatrix) {
	//Bind attributes
	var count = Math.min(model.relativeKeys.length, 3);	//We can blend together at most 3 shape keys
	
	for(i = 0; i < count; i++) {
		gl.bindBuffer(gl.ARRAY_BUFFER, model.shapeKeyBuffers[i]);
		
		gl.enableVertexAttribArray(gl.shaderProg.attributes["aPosition"+i]);
		gl.vertexAttribPointer(gl.shaderProg.attributes["aPosition"+i], 3, gl.FLOAT, false, 24, 0);
		
		gl.enableVertexAttribArray(gl.shaderProg.attributes["aNormal"+i]);
		gl.vertexAttribPointer(gl.shaderProg.attributes["aNormal"+i], 3, gl.FLOAT, false, 24, 12);
	}
	
	for(i = count; i < 3; i++) {
		gl.disableVertexAttribArray(gl.shaderProg.attributes["aPosition"+i]);
		gl.disableVertexAttribArray(gl.shaderProg.attributes["aNormal"+i]);
	}
	
	//Bind Uniforms
	if(count > 1)
		gl.uniform1f(gl.shaderProg.uniforms["uWeight1"], 0.7);
	else
		gl.uniform1f(gl.shaderProg.uniforms["uWeight1"], 0.0);
	gl.uniform1f(gl.shaderProg.uniforms["uWeight2"], 0.0);
	
	gl.uniformMatrix4fv(gl.shaderProg.uniforms["uPMatrix"], false, gl.pMatrix);
	gl.uniformMatrix4fv(gl.shaderProg.uniforms["uMVMatrix"], false, mvMatrix);
	gl.uniformMatrix3fv(gl.shaderProg.uniforms["uNMatrix"], false, nMatrix);
	
	//Textures
	if("textureIndex" in model) { 
		gl.bindBuffer(gl.ARRAY_BUFFER, model.textureBuffer);
		gl.vertexAttribPointer(gl.shaderProg.attributes["aTextureCoord"], 2, gl.FLOAT, false, 0, 0);
		
		gl.uniform1i(gl.shaderProg.uniforms["uUseTexture"], true);
		
		gl.activeTexture(gl.TEXTURE0);
		gl.bindTexture(gl.TEXTURE_2D, gl.textures[model.textureIndex]);
		gl.uniform1i(gl.shaderProg.uniforms["uSampler"], 0);
	} else {
		gl.uniform1i(gl.shaderProg.uniforms["uUseTexture"], false);
		gl.uniform3fv(gl.shaderProg.uniforms["uDiffuseColor"], model.diffuseColor);
	}
	
	gl.drawArrays(gl.TRIANGLES, 0, model.faceCount);
}

</script>

</head>

<body onLoad="startPage();">
	<canvas id="main-canvas" width="1024" height="768"></canvas>
	<div>
		<span>FPS: </span><span id="fps"></span>
		<button onClick="blinkClicked();">Blink!</button>
		<button onClick="puffClicked();">Puff Cheeks!</button>
	</div>
</body>

</html>
