<html>

<head>

<title>Shape Keys</title>

<script type="text/javascript" src="./other/gl-matrix-min.js"></script>
<script type="text/javascript" src="./other/webgl-utils.js"></script>
<script type="text/javascript" src="./webgl-helper.js"></script>
<script type="text/javascript" src="./camera.js"></script>

<script type="text/javascript">

function startPage() {
	var canvas = document.getElementById("main-canvas");
	var gl = initGL(canvas);
	
	initShaders(gl);
	initTextures(gl);
	initBuffers(gl);
	
	gl.clearColor(0.0, 0.0, 0.0, 1.0);
	gl.enable(gl.DEPTH_TEST);
	gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
	
	gl.pMatrix = mat4.create();
	mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, gl.pMatrix);
	
	gl.camera = new Camera();
	
	startAnimation(gl, tick);
}

function initShaders(gl) {
	attributeNames = ["aTextureCoord","aPosition0", "aNormal0", "aPosition1", "aNormal1", "aPosition2", "aNormal2" ];
	uniformNames = ["uWeight1", "uWeight2","uMVMatrix", "uPMatrix", "uNMatrix", "uSampler"];
	
	gl.shaderProg = createShaderProgram(gl, "shape_keys.vert", "shape_keys.frag", attributeNames, uniformNames);
	
	gl.useProgram(gl.shaderProg);

	for (a in gl.shaderProg.attributes) {
		var attribLoc = gl.shaderProg.attributes[a]
		gl.enableVertexAttribArray(attribLoc);
	}
	
	gl.disableVertexAttribArray(gl.shaderProg.attributes["aPosition2"]);
	gl.disableVertexAttribArray(gl.shaderProg.attributes["aNormal2"]);
}

function initTextures(gl) {
	gl.mainTexture = createTexture(gl, "images/Characterxa_Texa.png");
}

function initBuffers(gl) {
	var cube = JSON.parse(syncGET("models/main.js"));
	
	gl.faceCount = cube.faceCount;
	
	//gl.vertBuffer has both the vertices and the vertex normals
	gl.shapeKeyBuffers = [];

	for(i = 0; i < 2; i++) {
		gl.shapeKeyBuffers[i] = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, gl.shapeKeyBuffers[i]);
		gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(cube.shapeKeys[i]), gl.STATIC_DRAW);
	}
	
	//Texture buffers
	gl.mainTextureBuffer = gl.createBuffer();
	gl.bindBuffer(gl.ARRAY_BUFFER, gl.mainTextureBuffer);
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(cube.textureCoords), gl.STATIC_DRAW);
}

function tick(gl, timing) {
	draw(gl, timing);
	
	var fpsDiv = document.getElementById("fps");
	
	if(fpsDiv.innerHTML != timing.fps)
		fpsDiv.innerHTML = timing.fps;
}

function draw(gl, timing) {
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	
	var mvMatrix = mat4.create();

	mat4.identity(mvMatrix);
	mat4.rotateX(mvMatrix, degToRadian(-90));
	mat4.translate(mvMatrix, [0.0, 0.0, -1.05]);
	
	gl.camera.update(timing);
	var cMatrix = gl.camera.getViewMatrix();
	mat4.multiply(cMatrix, mvMatrix, mvMatrix);
	
	var nMatrix = mat3.create();
	mat4.toInverseMat3(mvMatrix, nMatrix);
	mat3.transpose(nMatrix);
	
	gl.bindBuffer(gl.ARRAY_BUFFER, gl.mainTextureBuffer);
	gl.vertexAttribPointer(gl.shaderProg.attributes["aTextureCoord"], 2, gl.FLOAT, false, 0, 0);
	
	//Bind attributes and uniforms 
	for(i = 0; i < 2; i++) {
		gl.bindBuffer(gl.ARRAY_BUFFER, gl.shapeKeyBuffers[i]);
		gl.vertexAttribPointer(gl.shaderProg.attributes["aPosition"+i], 3, gl.FLOAT, false, 24, 0);
		gl.vertexAttribPointer(gl.shaderProg.attributes["aNormal"+i], 3, gl.FLOAT, false, 24, 12);
	}
	
	//Blink
	if(timing.currentTime < blinkEnd) {
		var blinkWeight = (blinkEnd-timing.currentTime)/350.0;
		
		if(blinkWeight > 1.0) {
			blinkWeight = 2.0 - blinkWeight;
		}
		
		gl.uniform1f(gl.shaderProg.uniforms["uWeight1"], blinkWeight);
	}
	
	//Puff Cheeks
	if(timing.currentTime < puffEnd) {
		var puffWeight = (puffEnd-timing.currentTime)/500.0;
		
		if(puffWeight > 1.0) {
			puffWeight = 2.0 - puffWeight;
		}
		
		gl.uniform1f(gl.shaderProg.uniforms["uWeight2"], puffWeight);
	}
	
	gl.uniformMatrix4fv(gl.shaderProg.uniforms["uPMatrix"], false, gl.pMatrix);
	gl.uniformMatrix4fv(gl.shaderProg.uniforms["uMVMatrix"], false, mvMatrix);
	gl.uniformMatrix3fv(gl.shaderProg.uniforms["uNMatrix"], false, nMatrix);
	
	gl.activeTexture(gl.TEXTURE0);
	gl.bindTexture(gl.TEXTURE_2D, gl.mainTexture);
	gl.uniform1i(gl.shaderProg.uniforms["uSampler"], 0);
	
	gl.drawArrays(gl.TRIANGLES, 0, gl.faceCount);
}

var blinkEnd = new Date().getTime();
function blinkClicked() {
	blinkEnd = new Date().getTime()+700;
}

var puffEnd = new Date().getTime();
function puffClicked() {
	puffEnd = new Date().getTime()+1000;
}

</script>

</head>

<body onLoad="startPage();">
	<canvas id="main-canvas" width="1024" height="768"></canvas>
	<div>
		<span>FPS: </span><span id="fps"></span>
		<button onClick="blinkClicked();">Blink!</button>
		<button onClick="puffClicked();">Puff Cheeks!</button>
	</div>
</body>

</html>
